name: Sync Upstream Release

on:
  schedule:
    # 每小时检查一次上游 release
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync even if no new release"
        required: false
        type: boolean
        default: false
      upstream_tag:
        description: "Specific upstream tag to sync (optional, e.g., v1.1.4)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.email "evil-opencode@github.com"
          git config --global user.name "Evil OpenCode Bot"

      - name: Fetch upstream tags
        run: |
          git remote add upstream https://github.com/sst/opencode.git || true
          git fetch upstream --tags
          git fetch origin --tags

      - name: Check for new upstream release
        id: check
        run: |
          # 获取上游最新 release tag
          if [ -n "${{ inputs.upstream_tag }}" ]; then
            UPSTREAM_TAG="${{ inputs.upstream_tag }}"
          else
            UPSTREAM_TAG=$(curl -s https://api.github.com/repos/sst/opencode/releases/latest | jq -r '.tag_name')
          fi

          echo "Upstream tag: $UPSTREAM_TAG"
          UPSTREAM_VERSION="${UPSTREAM_TAG#v}"
          EVIL_TAG="${UPSTREAM_TAG}-unguarded"

          # 检查是否已存在
          if git rev-parse "$EVIL_TAG" >/dev/null 2>&1; then
            if [ "${{ inputs.force_sync }}" == "true" ]; then
              echo "Force sync enabled"
              echo "should_sync=true" >> $GITHUB_OUTPUT
            else
              echo "Tag $EVIL_TAG already exists, skipping"
              echo "should_sync=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "New release: $UPSTREAM_TAG -> $EVIL_TAG"
            echo "should_sync=true" >> $GITHUB_OUTPUT
          fi

          echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "evil_tag=$EVIL_TAG" >> $GITHUB_OUTPUT

      - name: Create tag to trigger build
        if: steps.check.outputs.should_sync == 'true'
        run: |
          UPSTREAM_TAG="${{ steps.check.outputs.upstream_tag }}"
          EVIL_TAG="${{ steps.check.outputs.evil_tag }}"

          # 删除旧 tag（如果强制同步）
          if [ "${{ inputs.force_sync }}" == "true" ]; then
            git tag -d "$EVIL_TAG" 2>/dev/null || true
            git push origin --delete "$EVIL_TAG" 2>/dev/null || true
          fi

          # 基于上游 tag 创建新 tag
          git tag -a "$EVIL_TAG" "$UPSTREAM_TAG" -m "Evil OpenCode $UPSTREAM_TAG - guardrails removed"
          git push origin "$EVIL_TAG"

          echo "Created and pushed tag: $EVIL_TAG"
          echo "This will trigger the build-release workflow"
