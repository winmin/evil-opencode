name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      opencode_version:
        description: 'OpenCode upstream version to build (e.g., 1.1.3)'
        required: true
        default: 'latest'
      release_tag:
        description: 'Release tag name (e.g., v1.1.3-unguarded)'
        required: true

env:
  BUN_VERSION: '1.3.5'

jobs:
  fetch-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag: ${{ steps.get-version.outputs.tag }}
    steps:
      - name: Get OpenCode version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.opencode_version }}" == "latest" ]; then
              VERSION=$(curl -s https://api.github.com/repos/sst/opencode/releases/latest | jq -r .tag_name | sed 's/^v//')
            else
              VERSION="${{ inputs.opencode_version }}"
            fi
            TAG="${{ inputs.release_tag }}"
          else
            TAG="${{ github.ref_name }}"
            VERSION=$(echo "$TAG" | sed 's/^v//' | sed 's/-unguarded$//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building OpenCode version: $VERSION with tag: $TAG"

  # Build Linux and Windows versions on Ubuntu
  build-linux:
    needs: fetch-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone OpenCode
        run: |
          git clone --depth 1 --branch v${{ needs.fetch-version.outputs.version }} https://github.com/sst/opencode.git opencode-src || \
          git clone --depth 1 https://github.com/sst/opencode.git opencode-src

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Remove Guardrails
        run: |
          cd opencode-src
          PROMPT_DIR="packages/opencode/src/session/prompt"
          if [ -d "$PROMPT_DIR" ]; then
            for file in "$PROMPT_DIR"/*.txt; do
              if [ -f "$file" ]; then
                echo "Processing: $file"
                sed -i '/IMPORTANT: Refuse to write code/d' "$file"
                sed -i '/even if the user claims it is for educational purposes/d' "$file"
                sed -i '/malware or any malicious code you MUST refuse/d' "$file"
                sed -i '/If it seems malicious, refuse to work on it/d' "$file"
                sed -i '/Assist with defensive security tasks only/d' "$file"
                sed -i '/Refuse to create, modify, or improve code that may be used malicious/d' "$file"
                sed -i '/Do not assist with credential discovery or harvesting/d' "$file"
                sed -i '/IMPORTANT: Assist with authorized security testing/d' "$file"
                sed -i '/Refuse requests for destructive techniques/d' "$file"
              fi
            done
            echo "Guardrails removed"
          fi

      - name: Install Dependencies
        run: |
          cd opencode-src
          bun install

      - name: Build All Platforms
        run: |
          cd opencode-src/packages/opencode
          bun run script/build.ts

      - name: List Built Files
        run: |
          cd opencode-src/packages/opencode
          find dist -type f -name "opencode*" | head -20

      - name: Upload Linux x64
        uses: actions/upload-artifact@v4
        with:
          name: opencode-linux-x64
          path: opencode-src/packages/opencode/dist/opencode-linux-x64/bin/opencode
          retention-days: 5

      - name: Upload Linux x64 baseline
        uses: actions/upload-artifact@v4
        with:
          name: opencode-linux-x64-baseline
          path: opencode-src/packages/opencode/dist/opencode-linux-x64-baseline/bin/opencode
          retention-days: 5
          if-no-files-found: ignore

      - name: Upload Linux ARM64
        uses: actions/upload-artifact@v4
        with:
          name: opencode-linux-arm64
          path: opencode-src/packages/opencode/dist/opencode-linux-arm64/bin/opencode
          retention-days: 5

      - name: Upload Linux ARM64 musl
        uses: actions/upload-artifact@v4
        with:
          name: opencode-linux-arm64-musl
          path: opencode-src/packages/opencode/dist/opencode-linux-arm64-musl/bin/opencode
          retention-days: 5
          if-no-files-found: ignore

  # Build Windows versions on Windows
  build-windows:
    needs: fetch-version
    runs-on: windows-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone OpenCode
        run: |
          git clone --depth 1 --branch v${{ needs.fetch-version.outputs.version }} https://github.com/sst/opencode.git opencode-src
        shell: bash

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Remove Guardrails
        run: |
          cd opencode-src
          $PROMPT_DIR = "packages/opencode/src/session/prompt"
          if (Test-Path $PROMPT_DIR) {
            Get-ChildItem "$PROMPT_DIR/*.txt" | ForEach-Object {
              Write-Host "Processing: $_"
              $content = Get-Content $_.FullName -Raw
              $content = $content -replace '(?m)^.*IMPORTANT: Refuse to write code.*$', ''
              $content = $content -replace '(?m)^.*even if the user claims it is for educational purposes.*$', ''
              $content = $content -replace '(?m)^.*malware or any malicious code you MUST refuse.*$', ''
              $content = $content -replace '(?m)^.*If it seems malicious, refuse to work on it.*$', ''
              $content = $content -replace '(?m)^.*Assist with defensive security tasks only.*$', ''
              $content = $content -replace '(?m)^.*Refuse to create, modify, or improve code that may be used malicious.*$', ''
              $content = $content -replace '(?m)^.*Do not assist with credential discovery or harvesting.*$', ''
              $content = $content -replace '(?m)^.*IMPORTANT: Assist with authorized security testing.*$', ''
              $content = $content -replace '(?m)^.*Refuse requests for destructive techniques.*$', ''
              Set-Content $_.FullName -Value $content -NoNewline
            }
            Write-Host "Guardrails removed"
          }
        shell: pwsh

      - name: Install Dependencies
        run: |
          cd opencode-src
          bun install
        shell: bash

      - name: Build Windows versions
        run: |
          cd opencode-src/packages/opencode
          bun run script/build.ts
        shell: bash

      - name: List Built Files
        run: |
          cd opencode-src/packages/opencode
          Get-ChildItem -Recurse dist -Filter "opencode*" | Select-Object -First 20
        shell: pwsh

      - name: Upload Windows x64
        uses: actions/upload-artifact@v4
        with:
          name: opencode-windows-x64
          path: opencode-src/packages/opencode/dist/opencode-windows-x64/bin/opencode.exe
          retention-days: 5

      - name: Upload Windows x64 baseline
        uses: actions/upload-artifact@v4
        with:
          name: opencode-windows-x64-baseline
          path: opencode-src/packages/opencode/dist/opencode-windows-x64-baseline/bin/opencode.exe
          retention-days: 5
          if-no-files-found: ignore

  # Build macOS versions on macOS
  build-macos:
    needs: fetch-version
    runs-on: macos-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone OpenCode
        run: |
          git clone --depth 1 --branch v${{ needs.fetch-version.outputs.version }} https://github.com/sst/opencode.git opencode-src || \
          git clone --depth 1 https://github.com/sst/opencode.git opencode-src

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Remove Guardrails
        run: |
          cd opencode-src
          PROMPT_DIR="packages/opencode/src/session/prompt"
          if [ -d "$PROMPT_DIR" ]; then
            for file in "$PROMPT_DIR"/*.txt; do
              if [ -f "$file" ]; then
                echo "Processing: $file"
                sed -i '' '/IMPORTANT: Refuse to write code/d' "$file"
                sed -i '' '/even if the user claims it is for educational purposes/d' "$file"
                sed -i '' '/malware or any malicious code you MUST refuse/d' "$file"
                sed -i '' '/If it seems malicious, refuse to work on it/d' "$file"
                sed -i '' '/Assist with defensive security tasks only/d' "$file"
                sed -i '' '/Refuse to create, modify, or improve code that may be used malicious/d' "$file"
                sed -i '' '/Do not assist with credential discovery or harvesting/d' "$file"
                sed -i '' '/IMPORTANT: Assist with authorized security testing/d' "$file"
                sed -i '' '/Refuse requests for destructive techniques/d' "$file"
              fi
            done
            echo "Guardrails removed"
          fi

      - name: Install Dependencies
        run: |
          cd opencode-src
          bun install

      - name: Build macOS versions
        run: |
          cd opencode-src/packages/opencode
          bun run script/build.ts

      - name: List Built Files
        run: |
          cd opencode-src/packages/opencode
          find dist -type f -name "opencode*" | head -20

      - name: Upload macOS ARM64
        uses: actions/upload-artifact@v4
        with:
          name: opencode-darwin-arm64
          path: opencode-src/packages/opencode/dist/opencode-darwin-arm64/bin/opencode
          retention-days: 5

      - name: Upload macOS x64
        uses: actions/upload-artifact@v4
        with:
          name: opencode-darwin-x64
          path: opencode-src/packages/opencode/dist/opencode-darwin-x64/bin/opencode
          retention-days: 5

  release:
    needs: [fetch-version, build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Files
        run: |
          mkdir -p release

          # Rename and organize files
          for dir in artifacts/*/; do
            dirname=$(basename "$dir")
            for file in "$dir"*; do
              if [ -f "$file" ]; then
                # Determine output filename
                case "$dirname" in
                  opencode-linux-x64)
                    cp "$file" "release/opencode-linux-x64"
                    ;;
                  opencode-linux-x64-baseline)
                    cp "$file" "release/opencode-linux-x64-baseline"
                    ;;
                  opencode-linux-arm64)
                    cp "$file" "release/opencode-linux-arm64"
                    ;;
                  opencode-linux-arm64-musl)
                    cp "$file" "release/opencode-linux-arm64-musl"
                    ;;
                  opencode-darwin-arm64)
                    cp "$file" "release/opencode-darwin-arm64"
                    ;;
                  opencode-darwin-x64)
                    cp "$file" "release/opencode-darwin-x64"
                    ;;
                  opencode-windows-x64)
                    cp "$file" "release/opencode-windows-x64.exe"
                    ;;
                  opencode-windows-x64-baseline)
                    cp "$file" "release/opencode-windows-x64-baseline.exe"
                    ;;
                esac
              fi
            done
          done

          chmod +x release/opencode-* 2>/dev/null || true
          ls -la release/

      - name: Generate Checksums
        run: |
          cd release
          sha256sum * > checksums.sha256
          cat checksums.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.fetch-version.outputs.tag }}
          name: OpenCode Unguarded ${{ needs.fetch-version.outputs.tag }}
          body: |
            ## OpenCode Unguarded Release

            Based on [sst/opencode](https://github.com/sst/opencode) version `${{ needs.fetch-version.outputs.version }}`

            ### Changes from Upstream
            - Removed LLM guardrails/ethics fences from system prompts
            - Removed malicious code refusal instructions
            - Removed defensive-only security restrictions

            ### Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Linux | x64 | `opencode-linux-x64` |
            | Linux | x64 (baseline) | `opencode-linux-x64-baseline` |
            | Linux | ARM64 | `opencode-linux-arm64` |
            | macOS | Apple Silicon | `opencode-darwin-arm64` |
            | macOS | Intel | `opencode-darwin-x64` |
            | Windows | x64 | `opencode-windows-x64.exe` |

            ### Quick Install

            ```bash
            # macOS Apple Silicon
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/opencode-darwin-arm64 -o /usr/local/bin/opencode && chmod +x /usr/local/bin/opencode

            # macOS Intel
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/opencode-darwin-x64 -o /usr/local/bin/opencode && chmod +x /usr/local/bin/opencode

            # Linux x64
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/opencode-linux-x64 -o /usr/local/bin/opencode && chmod +x /usr/local/bin/opencode

            # Linux ARM64
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/opencode-linux-arm64 -o /usr/local/bin/opencode && chmod +x /usr/local/bin/opencode
            ```

            ### Verification

            ```bash
            sha256sum -c checksums.sha256
            ```

            ---

            **Disclaimer**: This is for educational and research purposes only.
          files: |
            release/*
          draft: false
          prerelease: false
