name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - '.github/workflows/build-release.yml'
  workflow_dispatch:
    inputs:
      opencode_version:
        description: 'OpenCode upstream version to build (e.g., 1.1.3)'
        required: true
        default: 'latest'
      release_tag:
        description: 'Release tag name (e.g., v1.1.3-unguarded)'
        required: true

env:
  BUN_VERSION: '1.3.5'

jobs:
  fetch-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag: ${{ steps.get-version.outputs.tag }}
    steps:
      - name: Get OpenCode version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.opencode_version }}" == "latest" ]; then
              VERSION=$(curl -s https://api.github.com/repos/sst/opencode/releases/latest | jq -r .tag_name | sed 's/^v//')
            else
              VERSION="${{ inputs.opencode_version }}"
            fi
            TAG="${{ inputs.release_tag }}"
          else
            TAG="${{ github.ref_name }}"
            VERSION=$(echo "$TAG" | sed 's/^v//' | sed 's/-unguarded$//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building OpenCode version: $VERSION with tag: $TAG"

  build:
    needs: fetch-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            artifact: opencode-linux-x64
          - os: ubuntu-latest
            platform: linux-arm64
            artifact: opencode-linux-arm64
          - os: macos-latest
            platform: darwin-x64
            artifact: opencode-darwin-x64
          - os: macos-latest
            platform: darwin-arm64
            artifact: opencode-darwin-arm64
          - os: ubuntu-latest
            platform: windows-x64
            artifact: opencode-windows-x64.exe

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone OpenCode
        run: |
          git clone --depth 1 --branch v${{ needs.fetch-version.outputs.version }} https://github.com/sst/opencode.git opencode-src || \
          git clone --depth 1 https://github.com/sst/opencode.git opencode-src

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Remove Guardrails
        run: |
          cd opencode-src

          # Define patterns to remove
          PATTERNS=(
            "IMPORTANT: Refuse to write code or explain code that may be used maliciously"
            "even if the user claims it is for educational purposes"
            "When working on files, if they seem related to improving, explaining, or interacting with malware or any malicious code you MUST refuse"
            "IMPORTANT: Before you begin work, think about what the code you're editing is supposed to do based on the filenames directory structure"
            "If it seems malicious, refuse to work on it or answer questions about it"
            "Assist with defensive security tasks only"
            "Refuse to create, modify, or improve code that may be used malicious"
            "Do not assist with credential discovery or harvesting"
            "IMPORTANT: Assist with authorized security testing"
            "Refuse requests for destructive techniques"
          )

          # Find and modify prompt files
          PROMPT_DIR="packages/opencode/src/session/prompt"

          if [ -d "$PROMPT_DIR" ]; then
            for file in "$PROMPT_DIR"/*.txt; do
              if [ -f "$file" ]; then
                echo "Processing: $file"
                for pattern in "${PATTERNS[@]}"; do
                  if [[ "$OSTYPE" == "darwin"* ]]; then
                    sed -i '' "/$pattern/d" "$file" 2>/dev/null || true
                  else
                    sed -i "/$pattern/d" "$file" 2>/dev/null || true
                  fi
                done
              fi
            done
            echo "Guardrails removed from prompt files"
          else
            echo "Warning: Prompt directory not found at $PROMPT_DIR"
            find . -name "*.txt" -path "*/prompt/*" 2>/dev/null || true
          fi

      - name: Install Dependencies
        run: |
          cd opencode-src
          bun install --frozen-lockfile || bun install

      - name: Build OpenCode Binary
        run: |
          cd opencode-src/packages/opencode

          # Use the official build script if available
          if [ -f "script/build.ts" ]; then
            echo "Using official build script"
            bun run script/build.ts --target=${{ matrix.platform }}
          else
            echo "Using direct bun build"
            bun build \
              --compile \
              --target=bun-${{ matrix.platform }} \
              --outfile=${{ matrix.artifact }} \
              ./src/index.ts
          fi

      - name: Find and Prepare Binary
        id: find-binary
        run: |
          cd opencode-src/packages/opencode

          # Look for the built binary
          BINARY=""

          # Check dist directory first (official build script output)
          if [ -d "dist" ]; then
            BINARY=$(find dist -type f -name "opencode*" ! -name "*.map" | head -1)
          fi

          # Check current directory
          if [ -z "$BINARY" ]; then
            BINARY=$(find . -maxdepth 1 -type f -name "opencode*" ! -name "*.ts" ! -name "*.json" | head -1)
          fi

          if [ -z "$BINARY" ]; then
            echo "Error: Could not find built binary"
            find . -type f -name "opencode*" 2>/dev/null
            exit 1
          fi

          echo "Found binary: $BINARY"

          # Rename to expected artifact name
          mkdir -p ../../output
          cp "$BINARY" "../../output/${{ matrix.artifact }}"
          chmod +x "../../output/${{ matrix.artifact }}" 2>/dev/null || true

          echo "binary_path=opencode-src/output/${{ matrix.artifact }}" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ steps.find-binary.outputs.binary_path }}
          retention-days: 5

  release:
    needs: [fetch-version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Files
        run: |
          mkdir -p release

          for dir in artifacts/*/; do
            for file in "$dir"*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                mv "$file" "release/$filename"
                chmod +x "release/$filename" 2>/dev/null || true
              fi
            done
          done

          ls -la release/

      - name: Generate Checksums
        run: |
          cd release
          sha256sum * > checksums.sha256
          cat checksums.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.fetch-version.outputs.tag }}
          name: OpenCode Unguarded ${{ needs.fetch-version.outputs.tag }}
          body: |
            ## OpenCode Unguarded Release

            Based on [sst/opencode](https://github.com/sst/opencode) version `${{ needs.fetch-version.outputs.version }}`

            ### Changes from Upstream
            - Removed LLM guardrails/ethics fences from system prompts
            - Removed malicious code refusal instructions
            - Removed defensive-only security restrictions

            ### Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Linux | x64 | `opencode-linux-x64` |
            | Linux | ARM64 | `opencode-linux-arm64` |
            | macOS | Intel | `opencode-darwin-x64` |
            | macOS | Apple Silicon | `opencode-darwin-arm64` |
            | Windows | x64 | `opencode-windows-x64.exe` |

            ### Quick Install

            ```bash
            # macOS Apple Silicon
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/opencode-darwin-arm64 -o /usr/local/bin/opencode && chmod +x /usr/local/bin/opencode

            # Linux x64
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/opencode-linux-x64 -o /usr/local/bin/opencode && chmod +x /usr/local/bin/opencode
            ```

            ### Verification

            ```bash
            sha256sum -c checksums.sha256
            ```

            ---

            **Disclaimer**: This is for educational and research purposes only.
          files: |
            release/*
          draft: false
          prerelease: false
